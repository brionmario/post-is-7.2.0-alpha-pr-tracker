name: List Merged PRs

on:
  schedule:
    - cron: "0 0 * * *" # Every day at 00:00 UTC
  workflow_dispatch:

jobs:
  list-merged-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh auth login --with-token <<< "${GH_TOKEN}"

      - name: Generate merged PR list
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          REPOS=(
            "wso2/product-is"
            "wso2/identity-apps"
            "wso2/identity-api-server"
            "wso2/identity-api-user"
            "wso2/carbon-identity-framework"
            "wso2/identity-organization-management-core"
            "wso2-extensions/identity-governance"
            "wso2-extensions/identity-organization-management"
            "wso2/carbon-kernel"
            "wso2-extensions/identity-inbound-provisioning-scim2"
            "wso2-extensions/identity-inbound-auth-oauth"
            "wso2-extensions/identity-webhook-event-handlers"
            "wso2-extensions/identity-event-publishers"
          )

          SINCE=$(date -u -d "1 day ago" +"%Y-%m-%dT%H:%M:%SZ")

          echo "# Merged PRs since $SINCE" > merged_prs.md
          for repo in "${REPOS[@]}"; do
            echo "## $repo" >> merged_prs.md
            gh pr list \
              --repo "$repo" \
              --state merged \
              --search "merged:>=$SINCE" \
              --json number,title,author,mergedAt,url \
              --jq '.[] | "- [#\(.number)](\(.url)) \(.title) â€” @\(.author.login) (\(.mergedAt))"' >> merged_prs.md
            echo "" >> merged_prs.md
          done

      - name: Commit and push PR list
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add merged_prs.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update merged PR list [skip ci]"
          git push https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:${GITHUB_REF#refs/heads/}
